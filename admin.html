// ... (داخل قسم الـ Script في صفحة admin.html) ...

const todayKey = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');

function loadFullStatus() {
    // 1. جلب قائمة جميع المعلمين من نود teachers
    database.ref('teachers').on('value', (teachersSnapshot) => {
        const allTeachers = teachersSnapshot.val();
        
        // 2. جلب حضور اليوم
        database.ref('attendance/' + todayKey).on('value', (attendanceSnapshot) => {
            const attendanceData = attendanceSnapshot.val() || {};
            const tableBody = document.getElementById('attendanceTableBody');
            tableBody.innerHTML = "";

            if (!allTeachers) {
                tableBody.innerHTML = '<tr><td colspan="6">لا يوجد معلمين مسجلين في قاعدة البيانات</td></tr>';
                return;
            }

            // 3. المقارنة بين القائمتين
            for (let id in allTeachers) {
                const teacher = allTeachers[id];
                const record = attendanceData[id];
                
                if (record && record.inStatus !== "غائب") {
                    // المعلم حاضر
                    tableBody.innerHTML += `
                        <tr>
                            <td><strong>${record.name}</strong><br><small>${id}</small></td>
                            <td>${record.checkIn || '--:--'}</td>
                            <td style="color:red">${record.lateMins || 0}</td>
                            <td>${record.checkOut || '--:--'}</td>
                            <td>${record.earlyMins || 0}</td>
                            <td><span style="color:#27ae60">حاضر <i class="fas fa-check"></i></span></td>
                        </tr>`;
                } else {
                    // المعلم لم يبصم (غائب)
                    tableBody.innerHTML += `
                        <tr style="background-color: #fff5f5;">
                            <td><strong>${teacher.name}</strong><br><small>${id}</small></td>
                            <td>--:--</td><td>--</td><td>--:--</td><td>--</td>
                            <td><span class="status-absent" style="color:red; font-weight:bold;">غائب</span></td>
                        </tr>`;
                }
            }
        });
    });
}

// وظيفة زر "تسجيل غياب المتأخرين"
function recordAbsenceAll() {
    database.ref('teachers').once('value', (snapshot) => {
        const teachers = snapshot.val();
        database.ref('attendance/' + todayKey).once('value', (attSnapshot) => {
            const attendance = attSnapshot.val() || {};
            
            for (let id in teachers) {
                if (!attendance[id]) {
                    // تسجيله كغائب رسمياً في النظام
                    database.ref(`attendance/${todayKey}/${id}`).set({
                        name: teachers[id].name,
                        inStatus: "غائب",
                        checkIn: "غائب",
                        lateMins: 0
                    });
                }
            }
            alert("تم اعتماد غياب جميع من لم يحضر حتى الآن.");
        });
    });
}