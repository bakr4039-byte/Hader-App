<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقارير ثانوية الصحافة - بحث متقدم</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f4f7f6; padding: 20px; }
        .filter-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; text-align: center; }
        .input-group { display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap; }
        input[type="date"], select { padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-family: 'Tajawal'; }
        .btn-search { background: #3f51b5; color: white; border: none; padding: 10px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-top: 5px solid #3f51b5; }
        .stat-card h3 { font-size: 13px; color: #7f8c8d; margin: 0; }
        .stat-card p { font-size: 24px; font-weight: bold; margin: 10px 0 0; }
        
        table { width: 100%; background: white; border-collapse: collapse; border-radius: 15px; overflow: hidden; }
        th { background: #2c3e50; color: white; padding: 15px; font-size: 13px; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>
    <div class="filter-card">
        <h2><i class="fas fa-file-chart-column"></i> تقرير المعلمين التفصيلي</h2>
        <div class="input-group">
            <select id="tSel"><option value="all">جميع المعلمين</option></select>
            من: <input type="date" id="dateF">
            إلى: <input type="date" id="dateT">
            <button class="btn-search" onclick="loadReport()">عرض التقرير</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="border-top-color:#e74c3c"><h3>إجمالي الغياب</h3><p id="sAbs">0</p></div>
        <div class="stat-card" style="border-top-color:#f39c12"><h3>أيام التأخير</h3><p id="sLatD">0</p></div>
        <div class="stat-card" style="border-top-color:#f1c40f"><h3>دقائق التأخير</h3><p id="sLatM">0</p></div>
        <div class="stat-card" style="border-top-color:#9b59b6"><h3>مرات خروج مبكر</h3><p id="sEarD">0</p></div>
        <div class="stat-card" style="border-top-color:#8e44ad"><h3>دقائق خروج مبكر</h3><p id="sEarM">0</p></div>
        <div class="stat-card" style="border-top-color:#34495e"><h3>عدم انصراف</h3><p id="sNoO">0</p></div>
    </div>

    <table>
        <thead><tr><th>المعلم</th><th>التاريخ</th><th>حضور</th><th>انصراف</th><th>تأخير (د)</th><th>مبكر (د)</th></tr></thead>
        <tbody id="rBody"></tbody>
    </table>

    <script>
        const config = { databaseURL: "https://hader-system-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(config); const db = firebase.database();
        const START = "07:00", END = "13:00";

        db.ref('teachers').once('value', s => {
            const ts = s.val(); Object.keys(ts).forEach(id => {
                let opt = document.createElement('option'); opt.value = id; opt.innerHTML = ts[id].name;
                document.getElementById('tSel').appendChild(opt);
            });
        });

        async function loadReport() {
            const start = new Date(document.getElementById('dateF').value);
            const end = new Date(document.getElementById('dateT').value);
            const selId = document.getElementById('tSel').value;
            if(!start || !end) return alert("اختر التواريخ");

            let s = { abs:0, latD:0, latM:0, earD:0, earM:0, noO:0 };
            const tsSnap = await db.ref('teachers').once('value'); const ts = tsSnap.val();
            const body = document.getElementById('rBody'); body.innerHTML = "";

            for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const dateS = d.toLocaleDateString('en-GB').replace(/\//g, '-');
                const attS = await db.ref('attendance/'+dateS).once('value');
                const att = attS.val() || {};

                Object.keys(ts).forEach(id => {
                    if(selId !== 'all' && id !== selId) return;
                    const r = att[id];
                    if(!r) { s.abs++; body.innerHTML += `<tr style="color:red"><td>${ts[id].name}</td><td>${dateS}</td><td colspan="4">غائب</td></tr>`; }
                    else {
                        const l = diff(START, r.checkIn); const e = r.checkOut ? diff(r.checkOut, END) : 0;
                        if(l > 0) { s.latD++; s.latM += l; }
                        if(e > 0) { s.earD++; s.earM += e; }
                        if(!r.checkOut) s.noO++;
                        body.innerHTML += `<tr><td>${ts[id].name}</td><td>${dateS}</td><td>${r.checkIn||'-'}</td><td>${r.checkOut||'-'}</td><td>${l}</td><td>${e}</td></tr>`;
                    }
                });
            }
            document.getElementById('sAbs').innerText = s.abs; document.getElementById('sLatD').innerText = s.latD;
            document.getElementById('sLatM').innerText = s.latM; document.getElementById('sEarD').innerText = s.earD;
            document.getElementById('sEarM').innerText = s.earM; document.getElementById('sNoO').innerText = s.noO;
        }

        function diff(t1, t2) {
            if(!t1 || !t2 || t2 === '-') return 0;
            const [h1, m1] = t1.split(':').map(Number); const [h2, m2] = t2.split(':').map(Number);
            const d = (h2*60+m2)-(h1*60+m1); return d > 0 ? d : 0;
        }
    </script>
</body>
</html>