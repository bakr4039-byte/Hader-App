<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقارير ثانوية الصحافة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; background: #f9f9f9; padding: 20px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #34495e; color: white; padding: 10px; font-size: 12px; }
        td { padding: 10px; border: 1px solid #eee; text-align: center; }
        .btn-print { background: #27ae60; color: white; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; display: block; margin: 20px auto; }
    </style>
</head>
<body>
    <div class="card">
        <h1 style="text-align:center; color:#8e44ad;"><i class="fas fa-chart-pie"></i> التقرير الإحصائي العام</h1>
        <div class="controls">
            من: <input type="date" id="s"> إلى: <input type="date" id="e">
            <button onclick="calc()" style="background:#8e44ad; color:white; border:none; padding:8px 20px; border-radius:5px; cursor:pointer;">تحليل</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>المعلم</th>
                    <th>حضور</th>
                    <th>غياب</th>
                    <th>مرات التأخر</th>
                    <th>دقائق التأخر</th>
                    <th>مرات الخروج</th>
                    <th>دقائق الخروج</th>
                </tr>
            </thead>
            <tbody id="res"></tbody>
        </table>
        <button class="btn-print" onclick="window.print()">طباعة</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuOkZYWzjBTpuWdeibeEWC0tVR87byEEw",
            authDomain: "hader-system.firebaseapp.com",
            databaseURL: "https://hader-system-default-rtdb.firebaseio.com/", 
            projectId: "hader-system",
            storageBucket: "hader-system.firebasestorage.app",
            messagingSenderId: "1039709774940",
            appId: "1:1039709774940:web:078351fe5cb90593473299"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function calc() {
            const start = new Date(document.getElementById('s').value);
            const end = new Date(document.getElementById('e').value);
            database.ref('attendance').once('value', s => {
                const all = s.val();
                let stats = {};
                for(let date in all) {
                    const p = date.split('-');
                    const d = new Date(p[2], p[1]-1, p[0]);
                    if(d >= start && d <= end) {
                        for(let id in all[date]) {
                            const r = all[date][id];
                            if(!stats[id]) stats[id] = { name: r.name, p:0, a:0, lt:0, lm:0, ot:0, om:0 };
                            if(r.inStatus === "غائب") stats[id].a++;
                            else {
                                stats[id].p++;
                                if(r.lateMins > 0) { stats[id].lt++; stats[id].lm += Number(r.lateMins); }
                                if(r.outDuringDay > 0) { stats[id].ot++; stats[id].om += Number(r.outDuringDay); }
                            }
                        }
                    }
                }
                const res = document.getElementById('res');
                res.innerHTML = Object.keys(stats).map(id => `<tr>
                    <td>${stats[id].name}</td>
                    <td>${stats[id].p}</td>
                    <td>${stats[id].a}</td>
                    <td>${stats[id].lt}</td>
                    <td style="color:red">${stats[id].lm}</td>
                    <td>${stats[id].ot}</td>
                    <td style="color:#e67e22">${stats[id].om}</td>
                </tr>`).join('');
            });
        }
    </script>
</body>
</html>