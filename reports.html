<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير المتقدمة - ثانوية الصحافة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --dark-navy: #34495e; --purple: #8e44ad; --blue: #3498db;
            --danger: #e74c3c; --warning: #f39c12; --success: #27ae60;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .report-card { background: white; max-width: 1100px; margin: 0 auto; padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        
        .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* قسم اختيار التاريخ */
        .date-range-picker { display: flex; justify-content: center; gap: 15px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Tajawal'; }

        /* أزرار الفلترة */
        .filter-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn-filter { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; font-family: 'Tajawal'; transition: 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-filter:hover { opacity: 0.8; transform: translateY(-2px); }
        
        .f-all { background-color: var(--dark-navy); }
        .f-absent { background-color: var(--danger); }
        .f-late { background-color: var(--warning); }
        .f-early { background-color: #d35400; }
        .f-nocheckout { background-color: #7f8c8d; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background-color: #f2f2f2; padding: 12px; border: 1px solid #ddd; color: var(--dark-navy); }
        td { padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 15px; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .bg-absent { background: #fee2e2; color: #b91c1c; }
        .bg-late { background: #fef3c7; color: #92400e; }
        .bg-success { background: #dcfce7; color: #166534; }

        @media print { .nav-header, .date-range-picker, .filter-buttons, .print-btn { display: none; } }
    </style>
</head>
<body>

    <div class="report-card">
        <div class="header">
            <h1><i class="fas fa-file-invoice" style="color: var(--purple);"></i> نظام التقارير المتقدم</h1>
            <p>ثانوية الصحافة الأهلية</p>
        </div>

        <div class="date-range-picker">
            <label>من تاريخ:</label>
            <input type="date" id="startDate">
            <label>إلى تاريخ:</label>
            <input type="date" id="endDate">
            <button class="btn-filter f-all" onclick="fetchAllDataInRange()" style="background: var(--blue)">
                <i class="fas fa-sync-alt"></i> جلب البيانات
            </button>
        </div>

        <div class="filter-buttons">
            <button class="btn-filter f-all" onclick="filterResults('all')"><i class="fas fa-list"></i> الكل</button>
            <button class="btn-filter f-absent" onclick="filterResults('absent')"><i class="fas fa-user-times"></i> الغياب</button>
            <button class="btn-filter f-late" onclick="filterResults('late')"><i class="fas fa-clock"></i> التأخير</button>
            <button class="btn-filter f-early" onclick="filterResults('early')"><i class="fas fa-walking"></i> خروج مبكر</button>
            <button class="btn-filter f-nocheckout" onclick="filterResults('nocheckout')"><i class="fas fa-sign-out-alt"></i> لم ينصرف</button>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>المعلم</th>
                        <th>الحضور</th>
                        <th>الانصراف</th>
                        <th>تأخير (د)</th>
                        <th>مبكر (د)</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="reportBody">
                    <tr><td colspan="7">حدد التاريخ واضغط جلب البيانات</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuOkZYWzjBTpuWdeibeEWC0tVR87byEEw",
            authDomain: "hader-system.firebaseapp.com",
            databaseURL: "https://hader-system-default-rtdb.firebaseio.com/", 
            projectId: "hader-system",
            storageBucket: "hader-system.firebasestorage.app",
            messagingSenderId: "1039709774940",
            appId: "1:1039709774940:web:078351fe5cb90593473299"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fullRawData = []; // لتخزين البيانات المجلوبة مؤقتاً للفلترة

        async function fetchAllDataInRange() {
            const start = new Date(document.getElementById('startDate').value);
            const end = new Date(document.getElementById('endDate').value);
            const reportBody = document.getElementById('reportBody');

            if (!start || !end || isNaN(start.getTime())) return alert("يرجى تحديد التاريخ بشكل صحيح");

            reportBody.innerHTML = '<tr><td colspan="7">جاري المعالجة...</td></tr>';
            fullRawData = [];

            const snapshot = await database.ref('attendance').once('value');
            const allAttendance = snapshot.val();

            if (!allAttendance) {
                reportBody.innerHTML = '<tr><td colspan="7">لا توجد بيانات</td></tr>';
                return;
            }

            // فحص كل يوم في قاعدة البيانات
            Object.keys(allAttendance).forEach(dateStr => {
                // تحويل تاريخ Firebase (DD-MM-YYYY) إلى كائن تاريخ للمقارنة
                const parts = dateStr.split('-');
                const currentDate = new Date(parts[2], parts[1] - 1, parts[0]);

                if (currentDate >= start && currentDate <= end) {
                    const dailyRecords = allAttendance[dateStr];
                    Object.keys(dailyRecords).forEach(tId => {
                        fullRawData.push({
                            date: dateStr,
                            id: tId,
                            ...dailyRecords[tId]
                        });
                    });
                }
            });

            filterResults('all');
        }

        function filterResults(type) {
            const reportBody = document.getElementById('reportBody');
            let filtered = [];

            if (type === 'all') filtered = fullRawData;
            else if (type === 'absent') filtered = fullRawData.filter(r => r.inStatus === "غائب");
            else if (type === 'late') filtered = fullRawData.filter(r => Number(r.lateMins) > 0);
            else if (type === 'early') filtered = fullRawData.filter(r => Number(r.earlyMins) > 0);
            else if (type === 'nocheckout') filtered = fullRawData.filter(r => !r.checkOut && r.inStatus !== "غائب");

            if (filtered.length === 0) {
                reportBody.innerHTML = '<tr><td colspan="7">لم يتم العثور على نتائج تطابق هذا الفلتر</td></tr>';
                return;
            }

            reportBody.innerHTML = filtered.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td><strong>${r.name}</strong></td>
                    <td>${r.checkIn || '--:--'}</td>
                    <td>${r.checkOut || '--:--'}</td>
                    <td class="${r.lateMins > 0 ? 'badge bg-late' : ''}">${r.lateMins || 0}</td>
                    <td>${r.earlyMins || 0}</td>
                    <td>
                        <span class="badge ${r.inStatus === 'غائب' ? 'bg-absent' : 'bg-success'}">
                            ${r.inStatus || 'منضبط'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>