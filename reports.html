<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقارير ثانوية الصحافة</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f4f7f6; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat h3 { font-size: 12px; margin: 0; color: #7f8c8d; }
        .stat p { font-size: 20px; font-weight: bold; margin: 5px 0 0; }
        table { width: 100%; background: white; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>
    <div class="grid">
        <div class="stat"><h3>الغياب</h3><p id="sA">0</p></div>
        <div class="stat"><h3>التأخير (د)</h3><p id="sL">0</p></div>
        <div class="stat"><h3>خروج مبكر (د)</h3><p id="sE">0</p></div>
        <div class="stat"><h3>تم الانصراف</h3><p id="sC">0</p></div>
    </div>
    <input type="date" id="D" onchange="load()">
    <table>
        <thead><tr><th>المعلم</th><th>حضور</th><th>انصراف</th><th>تأخير</th><th>خروج مبكر</th></tr></thead>
        <tbody id="B"></tbody>
    </table>
    <script>
        const conf = { apiKey: "AIzaSyAuOkZYWzjBTpuWdeibeEWC0tVR87byEEw", databaseURL: "https://hader-system-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(conf); const db = firebase.database();
        const START = "07:00", END = "13:00";
        function load() {
            const d = document.getElementById('D').value.split('-').reverse().join('-');
            db.ref('teachers').once('value', st => {
                db.ref('attendance/' + d).once('value', sa => {
                    const ts = st.val() || {}, att = sa.val() || {};
                    let a=0, l=0, e=0, c=0, h="";
                    Object.keys(ts).forEach(id => {
                        const r = att[id];
                        if(!r) { a++; h += `<tr style="color:red"><td>${ts[id].name}</td><td colspan="4">غائب</td></tr>`; }
                        else {
                            if(r.checkOut) c++;
                            const lat = diff(START, r.checkIn); l += lat;
                            const ear = diff(r.checkOut || END, END); e += ear;
                            h += `<tr><td>${ts[id].name}</td><td>${r.checkIn||'-'}</td><td>${r.checkOut||'-'}</td><td>${lat}</td><td>${ear}</td></tr>`;
                        }
                    });
                    document.getElementById('B').innerHTML = h;
                    document.getElementById('sA').innerText = a; document.getElementById('sL').innerText = l;
                    document.getElementById('sE').innerText = e; document.getElementById('sC').innerText = c;
                });
            });
        }
        function diff(s, e) {
            if(!s || !e) return 0;
            const [h1, m1] = s.split(':').map(Number); const [h2, m2] = e.split(':').map(Number);
            const d = (h2*60+m2)-(h1*60+m1); return d > 0 ? d : 0;
        }
    </script>
</body>
</html>