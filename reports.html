<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقارير ثانوية الصحافة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f8fafc; margin: 0; }
        .top-nav { background: #1a237e; padding: 10px 20px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .filter-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        table { width: 100%; background: white; border-collapse: collapse; border-radius: 20px; overflow: hidden; }
        th { background: #1e293b; color: white; padding: 15px; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        .btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; color: white; font-family: 'Tajawal'; }
    </style>
</head>
<body>
    <div class="top-nav"><a href="admin.html" style="color:white; text-decoration:none;"><i class="fas fa-arrow-right"></i> العودة للإدارة</a></div>
    <div class="container">
        <div class="filter-card">
            <h2>تقرير الأداء التجميعي</h2>
            من: <input type="date" id="dateF"> إلى: <input type="date" id="dateT">
            <button class="btn" style="background:#3f51b5" onclick="loadR()">تحليل</button>
            <button class="btn" style="background:#27ae60" onclick="exportEX()">تصدير Excel</button>
        </div>
        <table id="rTable">
            <thead><tr><th>المعلم</th><th>الغياب</th><th>أيام التأخير</th><th>دقائق التأخير</th><th>خروج مبكر</th><th>بدون انصراف</th></tr></thead>
            <tbody id="rBody"></tbody>
        </table>
    </div>
    <script>
        const conf = { databaseURL: "https://hader-system-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(conf); const db = firebase.database();
        let sIn = "07:00", sOut = "13:00";
        db.ref('settings/official_times').on('value', s => { if(s.exists()){ sIn=s.val().start; sOut=s.val().end; }});

        async function loadR() {
            const start = new Date(document.getElementById('dateF').value), end = new Date(document.getElementById('dateT').value);
            const tsS = await db.ref('teachers').once('value'); const ts = tsS.val();
            let stats = {}; Object.keys(ts).forEach(id => stats[id] = { n:ts[id].name, a:0, ld:0, lm:0, em:0, no:0 });

            for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                const dk = d.toLocaleDateString('en-GB').replace(/\//g, '-');
                const adS = await db.ref('attendance/'+dk).once('value'); const ad = adS.val() || {};
                Object.keys(stats).forEach(id => {
                    const r = ad[id];
                    if(!r) stats[id].a++;
                    else {
                        const l = diff(sIn, r.checkIn); if(l>0){ stats[id].ld++; stats[id].lm+=l; }
                        const e = r.checkOut ? diff(r.checkOut, sOut) : 0; if(e>0) stats[id].em+=e;
                        if(r.checkIn && !r.checkOut) stats[id].no++;
                    }
                });
            }
            const body = document.getElementById('rBody'); body.innerHTML = "";
            Object.values(stats).forEach(s => {
                body.innerHTML += `<tr><td>${s.n}</td><td style="color:red">${s.a}</td><td>${s.ld}</td><td>${s.lm}</td><td>${s.em}</td><td>${s.no}</td></tr>`;
            });
        }
        function diff(t1, t2) {
            if(!t1 || !t2 || t2==='--') return 0;
            const [h1, m1] = t1.split(':').map(Number); const [h2, m2] = t2.split(':').map(Number);
            const d = (h2*60+m2)-(h1*60+m1); return d>0?d:0;
        }
        function exportEX() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('rTable')), 'تقرير.xlsx'); }
    </script>
</body>
</html>