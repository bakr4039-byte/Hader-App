<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير التفصيلية - ثانوية الصحافة</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3f51b5">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #3f51b5; --accent: #1a237e; --bg: #f8fafc; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* قسم الفلترة والبحث */
        .filter-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        .filter-grid { display: flex; gap: 15px; justify-content: center; align-items: flex-end; flex-wrap: wrap; margin-top: 15px; }
        .input-box { display: flex; flex-direction: column; text-align: right; gap: 5px; }
        input, select { padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: 'Tajawal'; min-width: 160px; }
        .btn-search { background: var(--primary); color: white; border: none; padding: 11px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-search:hover { background: var(--accent); }

        /* جدول البيانات المطور */
        .table-wrapper { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #1e293b; color: white; padding: 15px; font-size: 13px; white-space: nowrap; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 500; }
        tr:hover { background-color: #f9fbff; }

        /* ألوان التنبيه */
        .txt-danger { color: #e11d48; font-weight: bold; }
        .txt-warn { color: #d97706; }
        .txt-purple { color: #7c3aed; }
        .bg-light { background: #f8fafc; }
    </style>
</head>
<body>

    <div class="container">
        <div class="filter-card">
            <h2 style="margin:0; color:var(--accent);"><i class="fas fa-file-signature"></i> سجل الأداء التجميعي للمعلمين</h2>
            <div class="filter-grid">
                <div class="input-box">
                    <label>المعلم:</label>
                    <select id="teacherSelect"><option value="all">جميع المعلمين</option></select>
                </div>
                <div class="input-box">
                    <label>من تاريخ:</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="input-box">
                    <label>إلى تاريخ:</label>
                    <input type="date" id="dateTo">
                </div>
                <button class="btn-search" onclick="processReport()"><i class="fas fa-sync-alt"></i> تحليل البيانات</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>اسم المعلم</th>
                        <th style="background:#fff1f2; color:#be123c;">إجمالي الغياب</th>
                        <th style="background:#fffbeb; color:#b45309;">أيام التأخير</th>
                        <th style="background:#fffbeb; color:#b45309;">دقائق التأخير</th>
                        <th style="background:#f5f3ff; color:#6d28d9;">دقائق الخروج المبكر</th>
                        <th style="background:#f8fafc; color:#334155;">عدم انصراف</th>
                    </tr>
                </thead>
                <tbody id="reportContent">
                    <tr><td colspan="6">الرجاء تحديد النطاق الزمني والضغط على تحليل البيانات</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // إعدادات Firebase
        const firebaseConfig = { databaseURL: "https://hader-system-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // مواعيد العمل (سيتم تحديثها من الإعدادات)
        let START_TIME = "07:00"; 
        let END_TIME = "13:00";

        // 1. جلب المواعيد الرسمية من Firebase
        db.ref('settings/official_times').on('value', snap => {
            if(snap.exists()){
                START_TIME = snap.val().start;
                END_TIME = snap.val().end;
            }
        });

        // 2. تعبئة قائمة المعلمين تلقائياً
        db.ref('teachers').once('value', snap => {
            const list = snap.val() || {};
            const select = document.getElementById('teacherSelect');
            Object.keys(list).forEach(id => {
                let opt = document.createElement('option');
                opt.value = id